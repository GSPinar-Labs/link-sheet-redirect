<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirigiendo...</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="loader"></div>
    <h1 id="status">Buscando destino...</h1>
    <p id="message">Por favor espera</p>
    <div class="error" id="error"></div>
  </div>

  <script>
    async function redirect() {
      const statusEl = document.getElementById('status');
      const messageEl = document.getElementById('message');
      const errorEl = document.getElementById('error');
      const shortPath = window.location.pathname;
      
      if (shortPath === '/' || shortPath === '') {
        window.location.href = '/';
        return;
      }

      try {
        statusEl.textContent = 'Leyendo configuración...';
        
        // Read URL from url.txt
        const urlResponse = await fetch('/url.txt');
        if (!urlResponse.ok) {
          throw new Error('Archivo url.txt no encontrado. Crea el archivo con la URL del CSV.');
        }
        
        const sheetsUrl = (await urlResponse.text()).trim();
        if (!sheetsUrl) {
          throw new Error('El archivo url.txt está vacío.');
        }

        statusEl.textContent = 'Consultando base de datos...';
        
        const response = await fetch(sheetsUrl);
        if (!response.ok) {
          throw new Error('No se pudo acceder a la URL del CSV.');
        }

        const csvText = await response.text();
        const lines = csvText.trim().split('\n');
        const dataRows = lines.slice(2); // Skip first 2 rows
        
        for (let row of dataRows) {
          const [url, destination] = row.split(',').map(s => s.trim());
          if (!url || !destination) continue;
          
          const normalizedUrl = url.startsWith('/') ? url : '/' + url;
          
          if (normalizedUrl === shortPath) {
            statusEl.textContent = '¡Enlace encontrado!';
            messageEl.textContent = `Redirigiendo a ${destination}...`;
            setTimeout(() => {
              window.location.href = destination;
            }, 500);
            return;
          }
        }
        
        throw new Error(`No se encontró destino para: ${shortPath}`);
        
      } catch (error) {
        statusEl.textContent = 'Error';
        messageEl.textContent = '';
        errorEl.innerHTML = `
          <strong>❌ ${error.message}</strong>
          <br><br>
          <a href="/" class="btn">Volver al inicio</a>
        `;
        errorEl.style.display = 'block';
      }
    }

    redirect();
  </script>
</body>
</html>
